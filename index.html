<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>佛学研习社 - 交互笔记版</title>
    <style>
        :root { --bg: #f5f2ed; --sidebar-bg: #ffffff; --accent: #967d5a; --text: #2c2e2f; --border: #dcd7cc; }
        body, html { height: 100%; margin: 0; font-family: "PingFang SC", serif; background: var(--bg); color: var(--text); overflow: hidden; }
        .app-wrapper { display: flex; height: 100vh; }

        /* 左侧列表 */
        .sidebar { width: 40%; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--sidebar-bg); }
        .sidebar-header { padding: 25px; background: var(--accent); color: white; }
        .sidebar-header h2 { margin: 0; font-weight: 300; letter-spacing: 4px; font-size: 1.2rem; }
        .term-list { flex: 1; overflow-y: auto; }
        .term-item { border-bottom: 1px solid #f0eee9; }
        .term-header { padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .term-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #fbfaf8; }
        .term-item.active .term-content { max-height: 1200px; }

        /* 内容通用样式 */
        .detail-body { padding: 15px 25px 25px; font-size: 0.95rem; line-height: 1.8; }
        .label { font-weight: bold; color: var(--accent); display: block; margin-top: 10px; font-size: 0.85rem; border-bottom: 1px solid #eee; }
        .text-quote { font-style: italic; color: #555; background: #f9f7f2; padding: 10px; border-left: 3px solid var(--accent); margin: 5px 0; }
        .text-prac { background: #f2efea; padding: 12px; border-radius: 4px; margin-top: 5px; }

        /* 右侧对话区 */
        .chat-container { flex: 1; display: flex; flex-direction: column; background: #eeebdf; }
        #chat-window { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 90%; padding: 15px 20px; border-radius: 12px; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-msg { align-self: flex-end; background: var(--accent); color: white; }
        .gemini-msg { align-self: flex-start; background: white; border: 1px solid var(--border); white-space: pre-wrap; }

        /* 手动录入按钮 */
        .entry-btn { position: absolute; right: -45px; top: 0; background: var(--accent); color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        .input-area { padding: 20px; background: white; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        textarea { width: 100%; height: 60px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; resize: none; font-family: inherit; }
        .send-btn { align-self: flex-end; padding: 8px 25px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* Popup 录入弹窗 */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 450px; display: flex; flex-direction: column; gap: 10px; }
        .modal input, .modal textarea { padding: 8px; border: 1px solid var(--border); border-radius: 4px; width: 100%; box-sizing: border-box; }
        .modal textarea { height: 60px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="app-wrapper">
    <div class="sidebar">
        <div class="sidebar-header"><h2>佛学私藏词库</h2><div id="count" style="font-size:12px; opacity:0.8"></div></div>
        <div class="term-list" id="termList"></div>
    </div>

    <div class="chat-container">
        <div id="chat-window"><div class="message gemini-msg">欢迎。请告诉我你想研习的佛学概念。\n我会按照“短引、解释、常见误解、修持提示”为你整理。</div></div>
        <div class="input-area">
            <textarea id="userInput" placeholder="例如：什么是四依法？"></textarea>
            <button class="send-btn" onclick="askGemini()">提问</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="entryModal">
    <div class="modal">
        <h3 style="margin:0; color:var(--accent)">生成新词条</h3>
        <input type="text" id="in-t" placeholder="名称 (例如: 51) 苦集灭道)">
        <textarea id="in-q" placeholder="短引"></textarea>
        <textarea id="in-e" placeholder="解释"></textarea>
        <textarea id="in-m" placeholder="常见误解"></textarea>
        <textarea id="in-p" placeholder="修持提示"></textarea>
        <div class="modal-btns">
            <button onclick="closeModal()">取消</button>
            <button style="background:var(--accent); color:white; border:none; padding:8px 20px; border-radius:4px; cursor:pointer;" onclick="saveEntry()">确认添加到左侧</button>
        </div>
    </div>
</div>

<script>
    const API_KEY = "AIzaSyB5FyPB_XW5-2f98p12WFqI1je5H5WmDyg";
    let myTerms = [
        /* 这里请贴入你那50个原始词条数据 */
        {t:"1) 中阴（Bardo）", e:"在藏传体系里，中阴最常指死后到投生前的过渡阶段；广义也指一切“从一种状态到另一种状态的缝隙”（梦、禅定、临终）。", m:"把中阴当恐怖故事。", p:"日常练“转折处醒来”。", q:"“诸行无常。”"}
    ];

    function renderList() {
        const container = document.getElementById('termList');
        container.innerHTML = '';
        myTerms.forEach(item => {
            const wrap = document.createElement('div');
            wrap.className = 'term-item';
            wrap.innerHTML = `
                <div class="term-header" onclick="toggleItem(this)"><h3>${item.t}</h3><span>▼</span></div>
                <div class="term-content">
                    <div class="detail-body">
                        <span class="label">【短引】</span><div class="text-quote">${item.q}</div>
                        <span class="label">【解释】</span><div>${item.e}</div>
                        <span class="label">【常见误解】</span><div style="color:#8a6d6d">${item.m}</div>
                        <span class="label">【修持提示】</span><div class="text-prac">${item.p}</div>
                    </div>
                </div>`;
            container.appendChild(wrap);
        });
        document.getElementById('count').innerText = `当前词库：${myTerms.length} 条`;
    }

    function toggleItem(header) {
        const item = header.parentElement;
        const wasActive = item.classList.contains('active');
        document.querySelectorAll('.term-item').forEach(el => el.classList.remove('active'));
        if (!wasActive) item.classList.add('active');
    }

    async function askGemini() {
        const q = document.getElementById('userInput').value.trim();
        if (!q) return;
        appendMsg('user', q);
        document.getElementById('userInput').value = '';

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `请解释“${q}”。要求：请严格按照以下四个板块进行回复：1.短引 2.解释 3.常见误解 4.修持提示。内容要精炼深刻。` }] }]
                })
            });
            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text;
            appendMsg('gemini', text);
        } catch (e) {
            appendMsg('gemini', "连接失败，请检查网络。");
        }
    }

    function appendMsg(role, content) {
        const win = document.getElementById('chat-window');
        const div = document.createElement('div');
        div.className = `message ${role}-msg`;
        div.innerText = content;

        if (role === 'gemini') {
            const btn = document.createElement('button');
            btn.className = 'entry-btn';
            btn.innerHTML = '➕<br>录入';
            btn.onclick = () => openModal();
            div.appendChild(btn);
        }

        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    function openModal() { document.getElementById('entryModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('entryModal').style.display = 'none'; }

    function saveEntry() {
        const newTerm = {
            t: document.getElementById('in-t').value,
            q: document.getElementById('in-q').value,
            e: document.getElementById('in-e').value,
            m: document.getElementById('in-m').value,
            p: document.getElementById('in-p').value
        };
        if (!newTerm.t) return alert("请填写词条名称");
        myTerms.unshift(newTerm);
        renderList();
        closeModal();
        // 清空表单
        ['in-t','in-q','in-e','in-m','in-p'].forEach(id => document.getElementById(id).value = '');
    }

    renderList();
</script>
</body>
</html>
