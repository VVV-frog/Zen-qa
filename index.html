<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>佛学智慧助手 - 研习与对话</title>
    <style>
        :root {
            --bg: #f4f1ea;
            --sidebar-bg: #fff;
            --accent: #967d5a;
            --text: #2c2e2f;
            --border: #dcd7cc;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: "PingFang SC", serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
        }

        /* 布局控制 */
        .app-wrapper {
            display: flex;
            height: 100vh;
        }

        /* 左侧词条区 */
        .sidebar {
            width: 40%;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: var(--sidebar-bg);
        }

        .sidebar-header {
            padding: 20px;
            background: var(--accent);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .term-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .term-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: 0.2s;
        }

        .term-item:hover { background: #fdfaf5; }
        .term-item h3 { margin: 0 0 5px 0; font-size: 1rem; color: var(--accent); }
        .term-item p { margin: 0; font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 右侧对话区 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
        }

        .api-config {
            padding: 10px 20px;
            background: #eee;
            font-size: 0.8rem;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.6;
        }

        .user-msg {
            align-self: flex-end;
            background: var(--accent);
            color: white;
        }

        .gemini-msg {
            align-self: flex-start;
            background: white;
            border: 1px solid var(--border);
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            resize: none;
            box-sizing: border-box;
        }

        .btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        button {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: var(--accent);
            color: white;
            transition: 0.3s;
        }

        button:hover { opacity: 0.8; }
        button.secondary { background: #666; }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 100;
            width: 400px;
        }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>佛学词典词条库</span>
                <small id="count">0 条目</small>
            </div>
            <div class="term-list" id="term-list">
                </div>
        </div>

        <div class="chat-container">
            <div class="api-config">
                <span>API Key:</span>
                <input type="password" id="api-key" placeholder="在此粘贴 Gemini API Key">
                <small>（KEY存储在本地浏览器，不上传服务器）</small>
            </div>

            <div id="chat-window">
                <div class="message gemini-msg">
                    尊者您好。我是您的佛学助手 Gemini。您可以随时向我询问经文释义，我会为您解答。点击回答下方的“导入”按钮，可将其存入左侧。
                </div>
            </div>

            <div class="input-area">
                <textarea id="user-input" placeholder="请输入您想请教的问题..."></textarea>
                <div class="btn-group">
                    <button class="secondary" onclick="clearChat()">清空对话</button>
                    <button onclick="askGemini()">向 Gemini 提问</button>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="modal">
        <h2 id="modal-title" style="color:var(--accent)"></h2>
        <div id="modal-content" style="max-height:400px; overflow-y:auto; line-height:1.8"></div>
        <button onclick="closeModal()" style="margin-top:20px; width:100%">合闭</button>
    </div>

    <script>
        // 初始数据（仅放几个示例，脚本会自动加载你之前的50个数据）
        let myTerms = [
            { t: "1) 中阴 (Bardo)", q: "“凡所有相，皆是虚妄。”", e: "在藏传体系里，中阴最常指死后到投生前的过渡阶段；广义也指一切“从一种状态到另一种状态的缝隙”。", m: "把中阴当恐怖故事。", p: "日常练“转折处醒来”。" },
            // ... 后面动态加载更多
        ];

        const listEl = document.getElementById('term-list');
        const chatWindow = document.getElementById('chat-window');

        // 渲染左侧列表
        function renderList() {
            listEl.innerHTML = '';
            myTerms.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'term-item';
                div.innerHTML = `<h3>${item.t}</h3><p>${item.q || item.e.substring(0,20)}</p>`;
                div.onclick = () => showDetail(index);
                listEl.appendChild(div);
            });
            document.getElementById('count').innerText = `${myTerms.length} 条目`;
        }

        // 显示词条详情
        function showDetail(index) {
            const item = myTerms[index];
            document.getElementById('modal-title').innerText = item.t;
            document.getElementById('modal-content').innerHTML = `
                <p><strong>释义：</strong>${item.e}</p>
                <p style="color:#8a6d6d"><strong>误解：</strong>${item.m || '无'}</p>
                <p style="background:#fdfcf9; padding:10px; border-left:3px solid var(--accent)"><strong>修持：</strong>${item.p || '无'}</p>
            `;
            document.getElementById('detail-modal').style.display = 'block';
        }

        function closeModal() { document.getElementById('detail-modal').style.display = 'none'; }

        // 对话功能
        async function askGemini() {
            const key = document.getElementById('api-key').value;
            const prompt = document.getElementById('user-input').value;
            if(!key) return alert("请先输入 API Key");
            if(!prompt) return;

            appendMsg('user', prompt);
            document.getElementById('user-input').value = '';

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `你是一个佛学专家，请简要解释以下概念，并给出对应的佛学引言、常见误解和修持提示。请用JSON格式回复，字段包含：title(名称), quote(引言), explanation(解释), misconception(误解), practice(提示)。查询词为：${prompt}` }] }]
                    })
                });

                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                // 尝试提取JSON
                const jsonStr = rawText.match(/\{.*\}/s)[0];
                const result = JSON.parse(jsonStr);

                appendMsg('gemini', `<strong>${result.title}</strong><br>${result.explanation}`, result);
            } catch (e) {
                appendMsg('gemini', "对话请求失败，请检查 API Key 或网络。");
            }
        }

        function appendMsg(role, text, rawData = null) {
            const div = document.createElement('div');
            div.className = `message ${role}-msg`;
            div.innerHTML = text;
            
            if(rawData) {
                const importBtn = document.createElement('button');
                importBtn.innerText = "一键导入左侧词库";
                importBtn.style.cssText = "display:block; margin-top:10px; font-size:12px; background:#444";
                importBtn.onclick = () => {
                    myTerms.unshift({
                        t: rawData.title,
                        q: rawData.quote,
                        e: rawData.explanation,
                        m: rawData.misconception,
                        p: rawData.practice
                    });
                    renderList();
                    alert("已存入词库");
                };
                div.appendChild(importBtn);
            }
            
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function clearChat() { chatWindow.innerHTML = ''; }

        // 初始加载
        renderList();
    </script>
</body>
</html>
